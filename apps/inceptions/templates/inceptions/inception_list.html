{% extends 'base.html' %}
{% load static %}
{% load i18n %}



{% block custom_head_css_js %}
    <link href="{% static 'css/plugins/ztree/awesomeStyle/awesome.css' %}" rel="stylesheet">
    <script type="text/javascript" src="{% static 'js/plugins/ztree/jquery.ztree.all.min.js' %}"></script>
    <script src="{% static 'js/jquery.form.min.js' %}"></script>
	<style type="text/css">
        div#rMenu {
            position:absolute;
            visibility:hidden;
            text-align: left;
            top: 100%;
            left: 0;
            z-index: 1000;
            float: left;
            padding: 5px 0;
            margin: 2px 0 0;
            list-style: none;
            background-clip: padding-box;
        }
        div#rMenu li{
        	margin: 1px 0;
        	cursor: pointer;
        	{#list-style: none outside none;#}
        }
        .dropdown a:hover {
            background-color: #f1f1f1
        }
	</style>

{% endblock %}

{% block content %}
<div class="wrapper wrapper-content">
   <div class="row">

       <div class="col-lg-9 animated fadeInRight" id="split-right">
           <div class="tree-toggle">
               <div class="btn btn-sm btn-primary tree-toggle-btn" onclick="toggle()">
                   <i class="fa fa-angle-left fa-x" id="toggle-icon"></i>
               </div>
           </div>
           <div class="mail-box-header">
               <div class="uc pull-left m-r-5"><a class="btn btn-sm btn-primary btn-create-asset"> {% trans "Create Inception" %} </a></div>
               <div class="html5buttons">
                   <div class="dt-buttons btn-group">
                       <a class="btn btn-default btn_import" data-toggle="modal" data-target="#inception_import_modal" tabindex="0">
                           <span>{% trans "Import" %}</span>
                       </a>
                       <a class="btn btn-default btn_export" tabindex="0">
                           <span>{% trans "Export" %}</span>
                       </a>
                   </div>
               </div>

               <table class="table table-striped table-bordered table-hover " id="inception_list_table" style="width: 100%">
                   <thead>
                       <tr>
                           <th class="text-center"><input type="checkbox" class="ipt_check_all"></th>
                           <th class="text-center">{% trans 'Host' %}</th>
                           <th class="text-center">{% trans 'IP' %}</th>
                           <th class="text-center">{% trans 'User' %}</th>
                           <th class="text-center">{% trans 'Active' %}</th>
                           <th class="text-center">{% trans 'Type' %}</th>
                           <th class="text-center">{% trans 'Action' %}</th>
                       </tr>
                   </thead>
                   <tbody>
                   </tbody>
               </table>
               <div id="actions" class="hide">
                   <div class="input-group">
                       <select class="form-control m-b" style="width: auto" id="slct_bulk_update">
                           <option value="delete">{% trans 'Delete selected' %}</option>
                           <option value="update">{% trans 'Update selected' %}</option>
                       </select>
                       <div class="input-group-btn pull-left" style="padding-left: 5px;">
                           <button id='btn_bulk_update' style="height: 32px;"  class="btn btn-sm btn-primary">
                            {% trans 'Submit' %}
                           </button>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>
</div>


{% include 'inceptions/_inception_import_modal.html' %}
{% include 'inceptions/_inception_list_modal.html' %}
{% endblock %}

{% block custom_foot_js %}
<script>
$(document).ready()
.on('click', '.labels li', function () {
    var val = $(this).text();
    $("#inception_list_table_filter input").val(val);
    inception_table.search(val).draw();
 })
.on('click', '.btn_export', function () {
    var $data_table = $('#inception_list_table').DataTable();
    var rows = $data_table.rows('.selected').data();

    var inceptions = [];
    $.each(rows, function (index, obj) {
        inceptions.push(obj.id)
    });
    $.ajax({
        url: "{% url "inceptions:inception-export" %}",
        method: 'POST',
        data: JSON.stringify({inceptions_id: inceptions}),
        dataType: "json",
        success: function (data, textStatus) {
            window.open(data.redirect)
        },
        error: function () {
            toastr.error('Export failed');
        }
    })
})
.on('click', '#btn_inception_import', function () {
    var $form = $('#fm_inception_import');
    var action = $form.attr("action");

    $form.find('.help-block').remove();
    function success (data) {
        if (data.valid === false) {
            $('<span />', {class: 'help-block text-danger'}).html(data.msg).insertAfter($('#id_inceptions'));
        } else {
            $('#id_created').html(data.created_info);
            $('#id_created_detail').html(data.created.join(', '));
            $('#id_updated').html(data.updated_info);
            $('#id_updated_detail').html(data.updated.join(', '));
            $('#id_failed').html(data.failed_info);
            $('#id_failed_detail').html(data.failed.join(', '));
            var $data_table = $('#inception_list_table').DataTable();
            $data_table.ajax.reload();
        }
    }
    $form.ajaxSubmit({success: success});
})
.on('click', '.btn-create-asset', function () {
    var url = "{% url 'inceptions:inception-create' %}";

    window.open(url, '_self');
})


    function doActive() {
        var data = [];
        $.each(id_list, function(index, object_id) {
            var obj = {"pk": object_id, "is_active": true};
            data.push(obj);
        });
        function success() {
            inception_table.ajax.reload()
        }
        APIUpdateAttr({
            url: the_url,
            method: 'PATCH',
            body: JSON.stringify(data),
            success: success
        });
    }
    function doDelete() {
        swal({
            title: "{% trans 'Are you sure?' %}",
            text: "{% trans 'This will delete the selected inceptions !!!' %}",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "{% trans 'Confirm' %}",
            closeOnConfirm: false
        }, function() {
            var success = function() {
                var msg = "{% trans 'InceptionDeleted.' %}";
                swal("{% trans 'Inception Delete' %}", msg, "success");
                $('#inception_list_table').DataTable().ajax.reload();
            };
            var fail = function() {
                var msg = "{% trans 'Inception Deleting failed.' %}";
                swal("{% trans 'Inception Delete' %}", msg, "error");
            };
            var url_delete = the_url + '?id__in=' + JSON.stringify(id_list);
            APIUpdateAttr({
                url: url_delete,
                method: 'DELETE',
                success: success,
                error: fail
            });
            $data_table.ajax.reload();
            jumpserver.checked = false;
        });
    }
    function doUpdate() {
        var id_list_string = id_list.join(',');
        var url = "{% url 'inceptions:inception-bulk-update' %}?assets_id=" + id_list_string;
        location.href = url
    }

    switch(action) {
        case 'deactive':
            doDeactive();
            break;
        case 'delete':
            doDelete();
            break;
        case 'update':
            doUpdate();
            break;
        case 'active':
            doActive();
            break;
        default:
            break;
    }
    $(".ipt_check_all").prop("checked", false)
})
.on('click', '#btn_asset_modal_confirm', function () {
    var assets_selected = asset_table2.selected;
    var current_node;
    var nodes = zTree.getSelectedNodes();
    if (nodes && nodes.length === 1) {
        current_node = nodes[0]
    } else {
        return
    }

    var data = {
        'assets': assets_selected
    };
    var success = function () {
        asset_table2.selected = [];
        asset_table2.ajax.reload()
    };

    var url = '';
    if (update_node_action === "move") {
        url = "{% url 'api-assets:node-replace-assets' pk=DEFAULT_PK %}".replace("{{ DEFAULT_PK }}", current_node.id);
    } else {
        url = "{% url 'api-assets:node-add-assets' pk=DEFAULT_PK %}".replace("{{ DEFAULT_PK }}", current_node.id);
    }

    APIUpdateAttr({
        'url': url,
        'method': 'PUT',
        'body': JSON.stringify(data),
        'success': success
    })
}).on('hidden.bs.modal', '#asset_list_modal', function () {
    window.location.reload();
}).on('click', '#menu_asset_add', function () {
    update_node_action = "add"
}).on('click', '#menu_asset_move', function () {
    update_node_action = "move"
})
</script>

{% endblock %}